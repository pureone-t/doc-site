---
title: 24-Hour Video App (Serverless)
date: 2019-05-25T12:00:00+09:00
showDate: true
tags: ["dev", "AWS"]
---

# 24-Hour Video System
- 動画共有サイトの構築
- YouTubeのミニクローン

# 事前環境設定
## 前提
- AWS Accout Created.
- AWS CLI Installed.
- node.js Installed.

## IAMの作成
- アクセス権限の設定せずにIAMユーザを作成する
- 作成したユーザのアクセス権限設定より、インラインポリシーの追加（Lambda関数デプロイ権限ポリシー）を以下の通り行う

```
サービス: Lambda
アクション: GetFunction(読み込み)、UpdateFunctionCode(書き込み)、UpdateFunctionConfiguration(書き込み)
リソース: 指定 + すべて
名前: Lambda-Upload-Policy
```

- AWS CLIのユーザ認証の設定(aws configure)を行う

## Lambda関数デプロイ権限ポリシーのアタッチ
- IAMユーザを選択し、「アクセス権限」タブから「インラインポリシーの追加」を選択
- 「ビジュアルエディタ」タブから、「サービスの選択」→「Lambda」を選択し、「アクション選択」から以下を選択

## S3バケットの作成
以下の2つのバケット作成する
- アップロード用の格納先: XXX-upl
- 「Amazon Elastic Transcoder」がトランスコードした動画の格納先: XXX-trs

## IAMロールの作成
```
AWS サービス: Lambda
アクセス権限ポリシー: AWSLambdaExecute、AmazonElasticTranscoder_JobsSubmitter
ロール名: lambda-s3-execution-role
```

## Lambda関数の設定
- `Lambda`コンソールより、「Create Function」
- 一から作成

```
関数名: transcode-video
ランタイム: Node.js XX.X
アクセス権限:
  実行ロール: 既存のロールを使用する
  既存のロール: lambda-s3-execution-role
```

- 関数の作成

## Amazon Elastic Transcoderの設定
- `Elastic Transcoder`コンソールより、「Create a new Pipeline」

```yml
Create New Pipeline:
  Pipeline Name: 24 Hour Video
  Input Bucket: XXX-upl
  IAM Role: Create console default role
Configuration for Amazon S3 Bucket for Transcoded Files and Playlists:
  XXX-trs
  Storage Class: Standard
Configuration for Amazon S3 Bucket for Thumbnails:
  XXX-trs
  Storage Class: Standard
```

- Create Pipeline

## npmの設定
- PROJECTフォルダの作成
- `transcode-video`ディレクトリの作成
- package.jsonの作成
```
{
  "name": "transcode-video",
  "version": "1.0.0",
  "description": "Transcode Video Function",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "dependencies": {
    "aws-sdk": "latest"
  },
  "author": "Junichi Tsuchiya",
  "license": "BSD-2-Clause"
}
```
- `$ npm install`

# function
## index.js
- TODO link

## Local Test
- テストモジュールのインストール
  - `$ npm install run-local-lambda --save-dev`
  - `$ npm install aws-sdk`
- pakcage.jsonの内容を変更
  - `"test": "run-local-lambda --file index.js --event tests/event.json"`
- イベントオブジェクト定義ファイルの作成
  - `$ mkdir tests`
  - `$ vi event.json` // TODO link souce code

## Deployment
- `package.json` // TODO link souce code
- `$ npm run deploy`

## S3のトリガー設定
- S3コンソールより、`XXX-upl`バケットを選択し、「プロパティ」→「Events」→「通知の追加」
```
名前: Transcode Video
イベント: すべてのオブジェクト作成イベント
送信先:
  Lambda関数: transcode-video
```
- 保存（[アクセス権限エラーが発生した場合](#アクセス権限エラーが発生した場合)）

### アクセス権限エラーが発生した場合
- Lambdaコンソールより、「transcode-video」を選択し、「Designer」の左側にある「トリガーの追加」から「S3」を選択する
- 下部の「トリガーの設定」より以下を設定
```
バケット: XXX-upl
イベントタイプ: すべてのオブジェクトの作成イベント
```
- 「追加」→「保存」
- S3コンソールより、`XXX-upl`バケットを選択し、「プロパティ」→「Events」→「通知の追加」
- 先ほど作成したイベントが残っているため、名前を修正して保存する
```
名前: Transcode Video
```

## AWS Test
- S3コンソールより、`XXX-upl`バケットを選択し、mp4動画をアップロードする

# SNS通知
## トピックの作成
- SNSコンソールより、「トピック」→「新しいトピックの作成」
```
トピック: transcoded-video-notifications
```
- トピックの作成

## SNSのS3接続設定
- SNSコンソールより、作成したトピックを選択する
- 「編集」から「アクセスポリシー」の以下の部分を変更する
```Before
"Condition": {
  "StringEquals": {
    "AWS:SourceOwner": "XXXXXX"
  }
}
```
```After
"Condition": {
  "ArnLike": {
    "AWS:SourceArn": "arn:aws:s3:::XXX"
  }
}
```
- 変更の保存

## S3に設定を追加
- 「トランスコード済みバケット」→「プロパティ」→「Events」→「通知の追加」
```
名前: Transcoded Video
イベント: すべてのオブジェクト作成イベント
サフィックス: mp4
送信先:
  SNSトピック: transcoded-video-notifications
```
- 「保存」

## slack
- TODO

# アクセス権限の変更
## Lambda関数
- `set-permissions`




# 認証

`$ npm install local-web-server --save-dev`
